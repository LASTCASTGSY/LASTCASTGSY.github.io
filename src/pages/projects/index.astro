---
import BaseLayout from '../../layouts/BaseLayout.astro';
import '../../styles/global.css';
import { getCollection } from 'astro:content';

const base = import.meta.env.BASE_URL;

const projects = (await getCollection('projects'))
  .sort((a, b) => a.data.order - b.data.order);

const allTags = [...new Set(projects.flatMap(p => p.data.tags))].sort();
---

<BaseLayout title="Projects" description="ML research projects â€” diffusion imputation, wave forecasting, multimodal conditioning." activeNav="projects">
  <div class="container">
    <div class="page-header">
      <h1>Projects</h1>
      <p>Research and engineering work on score-based diffusion for time-series problems.</p>
    </div>

    <!-- Tag Filters (JS-driven) -->
    <div class="tag-filters" id="tag-filters">
      <button class="tag-filter active" data-tag="all">All</button>
      {allTags.map((tag) => (
        <button class="tag-filter" data-tag={tag}>{tag}</button>
      ))}
    </div>

    <div class="card-grid" id="project-grid">
      {projects.map((project) => (
        <a
          href={`${base}projects/${project.slug}/`}
          class="card"
          data-tags={project.data.tags.join(',')}
        >
          <span class={`card-status card-status--${project.data.status}`}>
            {project.data.status}
          </span>
          <h3>{project.data.title}</h3>
          <p>{project.data.description}</p>
          <div class="card-tags">
            {project.data.tags.map((t: string) => <span class="tag">{t}</span>)}
          </div>
        </a>
      ))}
    </div>
  </div>

  <script is:inline>
    document.querySelectorAll('.tag-filter').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tag-filter').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const tag = btn.getAttribute('data-tag');
        document.querySelectorAll('#project-grid .card').forEach(card => {
          if (tag === 'all') {
            card.style.display = '';
          } else {
            const tags = card.getAttribute('data-tags')?.split(',') || [];
            card.style.display = tags.includes(tag) ? '' : 'none';
          }
        });
      });
    });
  </script>
</BaseLayout>
